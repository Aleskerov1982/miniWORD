<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iDoc - Текстовый редактор</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-color: #007AFF;
            --bg-color: #F2F2F7;
            --surface-color: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border-color: #C6C6C8;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background-color: var(--surface-color);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            position: absolute;
            left: 0;
            right: 0;
            pointer-events: none;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 17px;
            padding: 8px;
            z-index: 1;
        }

        /* Toolbar */
        .toolbar {
            background-color: var(--surface-color);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            overflow-x: auto;
        }

        .toolbar-group {
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 18px;
        }

        .toolbar-btn.active {
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
        }

        /* Format Panel */
        .format-panel {
            background-color: var(--surface-color);
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: none;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .format-panel.active {
            display: flex;
        }

        .format-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            font-size: 16px;
        }

        .color-picker {
            width: 36px;
            height: 36px;
            border: none;
            background: none;
            padding: 0;
            border-radius: 50%;
            overflow: hidden;
        }

        /* Editor */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #editor {
            flex: 1;
            padding: 16px;
            background-color: var(--surface-color);
            border: none;
            outline: none;
            font-size: 16px;
            line-height: 1.5;
            overflow-y: auto;
        }

        /* Improved list styles */
        #editor ul, #editor ol {
            padding-left: 24px !important;
            margin: 8px 0;
        }

        #editor li {
            margin-bottom: 4px;
            padding-left: 8px;
        }

        /* Image styles */
        .editor-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--surface-color);
            border-radius: 14px;
            width: 100%;
            max-width: 400px;
            max-height: 80%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            position: relative;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 600;
        }

        .modal-close {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 17px;
        }

        .modal-body {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            border: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary-color);
        }

        /* Form elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            font-size: 16px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .toast.active {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="header-btn" id="backBtn">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="header-title" id="documentTitle">Новый документ</div>
        <button class="header-btn" id="menuBtn">
            <i class="fas fa-ellipsis"></i>
        </button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" id="boldBtn" title="Жирный">
                <i class="fas fa-bold"></i>
            </button>
            <button class="toolbar-btn" id="italicBtn" title="Курсив">
                <i class="fas fa-italic"></i>
            </button>
            <button class="toolbar-btn" id="underlineBtn" title="Подчеркивание">
                <i class="fas fa-underline"></i>
            </button>
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" id="alignLeftBtn" title="Выравнивание по левому краю">
                <i class="fas fa-align-left"></i>
            </button>
            <button class="toolbar-btn" id="alignCenterBtn" title="Выравнивание по центру">
                <i class="fas fa-align-center"></i>
            </button>
            <button class="toolbar-btn" id="alignRightBtn" title="Выравнивание по правому краю">
                <i class="fas fa-align-right"></i>
            </button>
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" id="bulletListBtn" title="Маркированный список">
                <i class="fas fa-list-ul"></i>
            </button>
            <button class="toolbar-btn" id="numberListBtn" title="Нумерованный список">
                <i class="fas fa-list-ol"></i>
            </button>
            <button class="toolbar-btn" id="formatBtn" title="Форматирование">
                <i class="fas fa-text-height"></i>
            </button>
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" id="insertImageBtn" title="Вставить изображение">
                <i class="fas fa-image"></i>
            </button>
        </div>
    </div>

    <!-- Format Panel -->
    <div class="format-panel" id="formatPanel">
        <select class="format-select" id="fontSizeSelect">
            <option value="12px">12px</option>
            <option value="14px" selected>14px</option>
            <option value="16px">16px</option>
            <option value="18px">18px</option>
            <option value="20px">20px</option>
            <option value="24px">24px</option>
        </select>
        
        <select class="format-select" id="fontFamilySelect">
            <option value="Arial">Arial</option>
            <option value="Helvetica" selected>Helvetica</option>
            <option value="Georgia">Georgia</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Verdana">Verdana</option>
        </select>
        
        <input type="color" class="color-picker" id="textColorPicker" value="#000000" title="Цвет текста">
    </div>

    <!-- Editor -->
    <div class="editor-container">
        <div id="editor" contenteditable="true">
            <p>Добро пожаловать в iDoc! Начните вводить текст...</p>
        </div>
    </div>

    <!-- Menu Modal -->
    <div class="modal" id="menuModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Действия с документом</div>
                <button class="modal-close" id="closeMenuModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-secondary" id="renameFileBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-edit" style="margin-right: 10px;"></i> Переименовать файл
                    </button>
                    <button class="btn btn-secondary" id="saveFileBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-save" style="margin-right: 10px;"></i> Сохранить как TXT
                    </button>
                    <button class="btn btn-secondary" id="exportPdfBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-file-pdf" style="margin-right: 10px;"></i> Экспорт в PDF
                    </button>
                    <button class="btn btn-secondary" id="loadFileBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-folder-open" style="margin-right: 10px;"></i> Загрузить файл
                    </button>
                    <button class="btn btn-secondary" id="printBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-print" style="margin-right: 10px;"></i> Печать
                    </button>
                    <button class="btn btn-secondary" id="wordCountBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-calculator" style="margin-right: 10px;"></i> Статистика
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Insert Image Modal -->
    <div class="modal" id="insertImageModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Вставить изображение</div>
                <button class="modal-close" id="closeImageModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Выберите изображение:</label>
                    <input type="file" id="imageFileInput" accept="image/*" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Или введите URL изображения:</label>
                    <input type="text" id="imageUrlInput" class="form-input" placeholder="https://example.com/image.jpg">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelImageBtn">Отмена</button>
                <button class="btn btn-primary" id="insertImageBtnModal">Вставить</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const editor = document.getElementById('editor');
            const formatPanel = document.getElementById('formatPanel');
            const formatBtn = document.getElementById('formatBtn');
            const menuBtn = document.getElementById('menuBtn');
            const menuModal = document.getElementById('menuModal');
            const insertImageModal = document.getElementById('insertImageModal');
            const toast = document.getElementById('toast');
            
            // Format buttons
            const boldBtn = document.getElementById('boldBtn');
            const italicBtn = document.getElementById('italicBtn');
            const underlineBtn = document.getElementById('underlineBtn');
            const alignLeftBtn = document.getElementById('alignLeftBtn');
            const alignCenterBtn = document.getElementById('alignCenterBtn');
            const alignRightBtn = document.getElementById('alignRightBtn');
            const bulletListBtn = document.getElementById('bulletListBtn');
            const numberListBtn = document.getElementById('numberListBtn');
            const insertImageBtn = document.getElementById('insertImageBtn');
            const fontSizeSelect = document.getElementById('fontSizeSelect');
            const fontFamilySelect = document.getElementById('fontFamilySelect');
            const textColorPicker = document.getElementById('textColorPicker');
            
            // Menu buttons
            const saveFileBtn = document.getElementById('saveFileBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const loadFileBtn = document.getElementById('loadFileBtn');
            const printBtn = document.getElementById('printBtn');
            const wordCountBtn = document.getElementById('wordCountBtn');
            const renameFileBtn = document.getElementById('renameFileBtn');
            
            // Image modal elements
            const imageFileInput = document.getElementById('imageFileInput');
            const imageUrlInput = document.getElementById('imageUrlInput');
            const cancelImageBtn = document.getElementById('cancelImageBtn');
            const insertImageBtnModal = document.getElementById('insertImageBtnModal');
            const closeImageModal = document.getElementById('closeImageModal');
            
            // Modal close buttons
            const closeMenuModal = document.getElementById('closeMenuModal');
            
            // State
            let isFormatPanelVisible = false;
            let currentDocument = {
                title: 'Новый документ',
                content: ''
            };
            
            // Initialize
            initEditor();
            
            function initEditor() {
                // Load last document if exists
                const savedDoc = localStorage.getItem('lastDocument');
                if (savedDoc) {
                    try {
                        const doc = JSON.parse(savedDoc);
                        editor.innerHTML = doc.content;
                        currentDocument = doc;
                        updateDocumentTitle();
                    } catch (e) {
                        console.error('Error loading document:', e);
                    }
                }
                
                setupEventListeners();
            }
            
            function setupEventListeners() {
                // Format panel toggle
                formatBtn.addEventListener('click', toggleFormatPanel);
                
                // Text formatting
                boldBtn.addEventListener('click', () => execCommand('bold'));
                italicBtn.addEventListener('click', () => execCommand('italic'));
                underlineBtn.addEventListener('click', () => execCommand('underline'));
                
                // Text alignment
                alignLeftBtn.addEventListener('click', () => execCommand('justifyLeft'));
                alignCenterBtn.addEventListener('click', () => execCommand('justifyCenter'));
                alignRightBtn.addEventListener('click', () => execCommand('justifyRight'));
                
                // Lists
                bulletListBtn.addEventListener('click', () => {
                    execCommand('insertUnorderedList');
                    setTimeout(applyListStyling, 10);
                });
                
                numberListBtn.addEventListener('click', () => {
                    execCommand('insertOrderedList');
                    setTimeout(applyListStyling, 10);
                });
                
                // Font size and family
                fontSizeSelect.addEventListener('change', () => {
                    const size = fontSizeSelect.value;
                    editor.style.fontSize = size;
                    updateCurrentDocument();
                });
                
                fontFamilySelect.addEventListener('change', () => {
                    const font = fontFamilySelect.value;
                    editor.style.fontFamily = font;
                    updateCurrentDocument();
                });
                
                // Text color
                textColorPicker.addEventListener('change', () => {
                    execCommand('styleWithCSS', false, true);
                    execCommand('foreColor', false, textColorPicker.value);
                });
                
                // Image insertion
                insertImageBtn.addEventListener('click', () => insertImageModal.classList.add('active'));
                
                // Menu
                menuBtn.addEventListener('click', () => menuModal.classList.add('active'));
                closeMenuModal.addEventListener('click', () => menuModal.classList.remove('active'));
                
                // File operations
                saveFileBtn.addEventListener('click', saveToFile);
                exportPdfBtn.addEventListener('click', exportToPdf);
                loadFileBtn.addEventListener('click', loadFromFile);
                printBtn.addEventListener('click', printDocument);
                wordCountBtn.addEventListener('click', showWordCount);
                renameFileBtn.addEventListener('click', renameDocument);
                
                // Image modal
                closeImageModal.addEventListener('click', () => insertImageModal.classList.remove('active'));
                cancelImageBtn.addEventListener('click', () => insertImageModal.classList.remove('active'));
                insertImageBtnModal.addEventListener('click', insertImageFromModal);
                
                // Editor events
                editor.addEventListener('input', updateCurrentDocument);
            }
            
            function toggleFormatPanel() {
                isFormatPanelVisible = !isFormatPanelVisible;
                formatPanel.classList.toggle('active', isFormatPanelVisible);
                formatBtn.classList.toggle('active', isFormatPanelVisible);
            }
            
            function execCommand(command) {
                document.execCommand(command, false, null);
                editor.focus();
                updateCurrentDocument();
            }
            
            function applyListStyling() {
                const lists = editor.querySelectorAll('ul, ol');
                lists.forEach(list => {
                    if (!list.style.paddingLeft) {
                        list.style.paddingLeft = '24px';
                    }
                });
            }
            
            function insertImageFromModal() {
                let imageSrc = '';
                
                if (imageFileInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        imageSrc = event.target.result;
                        insertImageToEditor(imageSrc);
                    };
                    reader.readAsDataURL(imageFileInput.files[0]);
                } else if (imageUrlInput.value) {
                    imageSrc = imageUrlInput.value;
                    insertImageToEditor(imageSrc);
                } else {
                    showToast('Выберите изображение или введите URL');
                    return;
                }
            }
            
            function insertImageToEditor(src) {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'editor-image';
                img.style.maxWidth = '100%';
                
                // Insert at cursor position
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.insertNode(img);
                    
                    // Add space after image
                    const textNode = document.createTextNode('\u00A0');
                    range.insertNode(textNode);
                    
                    // Move cursor after image
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                
                updateCurrentDocument();
                insertImageModal.classList.remove('active');
                showToast('Изображение вставлено');
                
                // Reset form
                imageFileInput.value = '';
                imageUrlInput.value = '';
            }
            
            function updateCurrentDocument() {
                currentDocument.content = editor.innerHTML;
                localStorage.setItem('lastDocument', JSON.stringify(currentDocument));
            }
            
            function saveToFile() {
                const content = editor.innerText;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentDocument.title + '.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Файл сохранен как TXT');
                menuModal.classList.remove('active');
            }
            
            function exportToPdf() {
                showToast('Создание PDF...');
                
                html2canvas(editor).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 190;
                    const pageHeight = 280;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 10;
                    
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight + 10;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(currentDocument.title + '.pdf');
                    showToast('PDF успешно создан');
                    menuModal.classList.remove('active');
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    showToast('Ошибка при создании PDF');
                });
            }
            
            function loadFromFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = e => {
                            editor.innerHTML = e.target.result;
                            currentDocument.title = file.name.replace('.txt', '');
                            updateDocumentTitle();
                            updateCurrentDocument();
                            showToast('Файл загружен');
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
                menuModal.classList.remove('active');
            }
            
            function printDocument() {
                window.print();
                menuModal.classList.remove('active');
            }
            
            function showWordCount() {
                const text = editor.innerText;
                const words = text.trim() ? text.trim().split(/\s+/).length : 0;
                const chars = text.length;
                const charsNoSpaces = text.replace(/\s/g, '').length;
                const lines = text.split(/\r\n|\r|\n/).length;
                
                alert(`Статистика документа:\n\nСлов: ${words}\nСимволов: ${chars}\nСимволов (без пробелов): ${charsNoSpaces}\nСтрок: ${lines}`);
                menuModal.classList.remove('active');
            }
            
            function renameDocument() {
                const newName = prompt('Введите новое название документа:', currentDocument.title);
                if (newName && newName.trim()) {
                    currentDocument.title = newName.trim();
                    updateDocumentTitle();
                    updateCurrentDocument();
                    showToast('Документ переименован');
                }
                menuModal.classList.remove('active');
            }
            
            function updateDocumentTitle() {
                document.getElementById('documentTitle').textContent = currentDocument.title;
            }
            
            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('active');
                setTimeout(() => {
                    toast.classList.remove('active');
                }, 3000);
            }
        });

        // Prevent zoom in Telegram Web Apps
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });

        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>